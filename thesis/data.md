# Data

## Introduction

Three types of observations were made at Happy Valley and at CLPX: airborne surveys of snow-free surface heights (DEMs), airborne surveys of snow-covered (near peak seasonal accumulation) surface heights (DSMs), and field measurements of snow depth. Among the airborne data is both lidar and structure-from-motion (SfM) photogrammetry, with orthosmosaic images available from the latter. These data are used to generate high resolution (1 m) maps of snow depth at landscape scales. Snow depth maps are computed by subtracting the snow-free DEM from the snow-covered DSM and are then validated using the field data that was collected concurrently with the airborne snow-covered surface height surveys. Between the two study areas there are twelve snow depth maps collected over seven years (2012 - 2018) which are comprised of over 600 million snow depth records and validated by 141,207 field measurements of snow depth. Care was taken to achieve consistent and convergent geospatial data paramters within and across study areas during the processing phase (Table 1). This report and the attached appendicies detail the preparation of the DEMs and DSMs, computation of the snow depth maps, and the validation of the snow depth maps using the in situ snow depth measurements.

###### Table 1: DEM and DSM Metadata
| Metadata Property | Happy Valley | CLPX |
|-------------------------------|----------------------------|----------------------------|
| File Format | GeoTIFF raster (.tif) | GeoTIFF raster (.tif) |
| Data Type | 32-bit floating point | 32-bit floating point |
| Coordinate Reference System | UTM Zone 6 N (EPSG: 32606) | UTM Zone 6 N (EPSG: 32606) |
| 'No Data' Value | -9999 | -9999 |
| Spatial Resolution | 1 m | 1 m |
| Dimensions (x, y) | (3400, 15400) | (13750, 11100) |
| Upper Left Coordinate (x, y) | (421000, 7678000) | (401900, 7620200) |
| Lower Left Coordinate (x, y) | (421000, 7663600) | (401900, 7609100) |
| Upper Right Coordinate (x, y) | (424400, 7678000) | (415650, 7620200) |
| Lower Right Coordinate (x, y) | (424400, 7663600) | (415650, 7609100) |
| Center (x,y) | (422700, 7670300) | (408775, 7614650) |
| Size on Disk | 200 MB | 583 MB |


## Bare-Earth DEMs
The high resolution DEM of the bare landscape (no snow or leafy vegetation) surface is literally the foundation of airborne surface differential snow depth mapping. For each study area, individual DEMs were acquired in early June of two separate years (2012 and 2017) using two different techniques (lidar and SfM). Each of set of DEMs has relative strengths and weaknesses: the 2012 lidar DEMs are derived from sparser point clouds and cover smaller swaths than the 2017 data, but remnant snowdrfits cover portions of the 2017 SfM DEMs and thus hide the true surface heights. The remant snowdrifts raise the 2017 DEM surface by amounts ranging from 10 cm (at snowdrift edges) up to several meters (at snowdrift depth maxima). The lidar and SfM DEMs of each study area are fused together to mitigate the indiviudal weaknesses and to minimize the influence of dynamic landscape surface height factors such as frost heave and vegetation growth. A 'master' DEM for each study area is generated by prescribing different surface heights based on the status of the data (Table 2).
###### Table 2: 'Master' DEM matrix
| DEM Conditions          | Source of Elevation Value       |
|------------------------ |------------------------------|
| Confidence in 2012 and 2017 DEMs | Mean of 2012 and 2017 DEM |
| No Data in 2012 DEM | 2017 DEM* (SfM) |
| Snowdrift coverage in 2017 DEM | 2012 DEM (lidar)             |

<sub>*The 2017 DEM surface is shifted downward by 0.12 m (the mean of the 2017-2012 DEM difference (with snowdrifts masked out) map minus one standard deviation) to minimize border artifacts where the two DEMs meet.</sub>

The general steps to compute the master DEMs are as follows:
1. Generate 2012 and 2017 gridded DEMs with the desired parameters (Table 1).
2. Subtract the 2012 DEM from the 2017 DEM
3. Create a 2017 snowdrift location mask
4. Compute the mean of the 2012 and 2017 DEMs outside the snowdrift mask.
5. Retreive the 2012 DEM values within the snowdrift mask.
6. Create a new DEM joining the mean values and the 2012 values.
7. Overlay this new DEM on the (adjusted) 2017 DEM - effectively padding the new DEM with the larger swath of the 2017 DEM.
8. Write the data to a 'master' DEM.

These steps are documented and detailed in the DEM preparation appendix of each study area. The end result is a high confidence DEM suitable for the computation of seasonal snow depth maps.

## Snow-Covered DSMs

Near the end of each of the seven winters (2012 through 2018, except in 2014), mid-April airborne surveys acquired the surface heights of the mature, near-peak winter snowcover at each study area. The 2012 and 2013 snow-covered DSMs are generated from lidar, while all others are derived from SfM. The gridded rasters of the snow depth surface (a snow-covered digital surface model (DSM)) are used to compute snow depth maps by subtracting the bare earth DEM. The generation and processing of the DSMs is detailed in the DSM preparation appendices, and the DSMs conform to the same data parameters prescribed earlier (Table 1).
###### Table? Day of Year, data type

### Data 2.1 2012 and 2013 Winter Surfaces (from lidar via PDAL)

## Snow Depth Maps

The snow depth maps are the element-wise difference of the summer, bare-earth DEM from the winter, snow-covered DSM:
$$H{snow}_{ij} = HsnowcoverDSM_{ij} - HsummerDEM_{ij}$$

The computation the snow depth maps is a straightforward subtraction. Details are available in snow depth map appendices. Each snow depth map has the same extents and metadata as the parent surfaces (Table 1). All snow depth maps measure depth in meters. The high resolution maps capture both landscape and local patterns of snow depth distribution and reveal a striking heterogeneity within the tundra snowcover (Figure 1.)

###### Figure 1: Snow Depth Map (like in the camden whitepaper)

After computing each depth map, the result is compared to a set of manual snow depth measurements made in the field conincident with the acquisition of the snow-covered DSM to determine accuracy.

## Snow Depth Map Validation

Over a hundred thousand snow depth measurements made with a GPS-enabled automatic probe (Sturm and Holmgren, 2018) validate the snow depth maps (e.g. Figure 2). A custom Python script (see validation appendix) computes the difference between the probe measurement and the value of the snow depth map pixel for that location. This difference between the  and the map value is the error. A similar script then compares these error values to several terrain derivatives (e.g. slope, aspect) to determine if there is a geographic or topographic trend, or if the errors have stationarity. After error aggregation and analysis a correction value is applied to each depth map such that map values fit the 'true' probe values as best is possible.
Over a hundred thousand snow depth measurements made with a GPS-enabled automatic probe (Sturm and Holmgren, 2018) validate the snow depth maps (e.g. Figure 2). A custom Python script (see validation appendix) computes the difference between the probe measurement and the value of the snow depth map pixel for that location. This difference between the map value and the probe depth is the error. A similar script then compares these error values to several terrain derivatives (e.g. slope, aspect) to determine if there is a geographic or topographic trend, or if the errors have stationarity. After error aggregation and analysis a correction value is applied to each depth map such that map values fit the 'true' probe values as best is possible.

###### Figure 2: An example of a field validation campaign: CLPX 2012; 32571 MagnaProbe validation points (black dots).

![alt text](../validation/clpx/2012/figs/validation_depth_map.png)

The primary sources of uncertainty in the snow depth maps are geolocation errors in the parent DEMs and DSMs. Geolocation errors contribute uncertainity to the snow depth maps in two ways: 1) Inaccurate measurements of surface height within each parent DEM/DSM are passed down to the snow depth map, and 2) poor geographic coregistration between the DEM and DSM. The former will produce especially severe errors where the change in true surface height is large compared to the ground sample distance (i.e. steep or rough terrain). The geolocation uncertainty within the parent DEMs/DSMs arises from the limits of the GPS onboard the aircraft and from how the GPS data is processed while building the point clouds derived from the raw laser returns (lidar) or aerial photographs (SfM). Based on previous experience \[Nolan et al., 2015\] we understand the geolocation error within the parent DEM / DSMs to be on the order of plus or minus 0.30 m. The upper limit of the accuracy of the snow depth maps (unadjusted by probe measurements) is expected to be plus or minus 0.10 m. Natural dynamic landscape factors such as frost heave, shrub bending, shrub leaf-out, and the nature of the snowcover itself may also influence results.

The probe measurements of snow depth used to validate the snow depth maps also have substantial geolocation errors (on the order of 5 m) caused by the non-differential GPS onboard the instrument. Additionally, a quasi-random vertical error in depth exists that is almost always too high (as much as 0.05 m) that is caused by the tendency to 'over-probe' down into the substrate below the snow. However, the probe is considered the true snow depth measurement in our study and we leverage the large number of measurements to validate the snow depth maps as best as possible. We believe that over the course of a measurement campaign the combination of all of the above errors (airborne and probe) cause the surface height and resulting snow depth measurements to 'float' some amount away from their actual values - and the amount of this float (as we will show) must in someway be close to a fixed offset for the survey. Given the above sources of uncertainty and lack of high fidelity ground control points, we expect corrected snow depth maps accuracies to range between 0.10 and 0.40 m.

A total of 141,207 MagnaProbe points between both study areas were used in this validation process. The distributions of these snow depth measurements and their corresponding snow depth raster values are found in Figure 12. The mean error (probe minus snow depth map) for all years and study areas is 0.16 m (Table 3).

###### Table 3: Snow Depth Map Validation Results

![alt text](../validation/aggregate_results/figs/aggregate_results_summary.png)

The airborne retreivals of snow depth underestimate the probe snow depth. Nearly all of the snow depth map values are too shallow, but their statistical distributions are similar to those of the probes. The interannual variabilty of distribution shape is largely driven by different field measurement survey strategies.

![alt text](../validation/aggregate_results/figs/probe_v_rstr_violin.png)

In each year the median error at CLPX is greater than at Happy Valley (Figure 4). This may be due to probe survey differences - but the terrain, wind regime, and resulting snowcover at CLPX are also much different than at Happy Valley. The katabatic-intensified patterns of drift and scour over the eastern portion of the CLPX domain are likely more difficult targets - especially the scour zones. Note that validation data is missing for Happy Valley in 2016 (see the validation appendix for notes on how this depth map was adjusted).

###### Figure 4: Box Plots of Errors (MagnaProbe  minus Snow Depth Map) by Year and Study Area

![alt text](../validation/aggregate_results/figs/validation_box.png)

# Pick it up here

To determine the presence of any geographic trend in the errors geographic zone labels are prescribed to different sets of MagnaProbe points for each study area. The CLPX points are divided into 4 zones: CLPX East, Imnavait, Imnavait North, and CLPX West. These four zones  capture different MagnaProbe sampling regimes and the general trend of wind and snow characteristics known to exist in this domain: deeper snow and milder winds in the West and shallower snow scoured by strong katabatic winds in the East [Sturm and Stuefer, 2013]. Happy Valley is split into five zones: Happy Valley North, Happy Valley South, Watertracks, Crescent Lake, and Happy Valley Stream. Total (Figures 15 and 16) and annual (Figure 17) errors are compared across these geographic zones to illuminate any potential geographic or sampling regime bias in the errors.
</p>

###### Figure 15: Violin Plots of Errors by Geographic Zone
![alt text](../validation/aggregate_results/figs/violin_xstudyarea_zonehue.png)
###### Figure 16: Box Plots of Errors by Geographic Zone
![alt text](../validation/aggregate_results/figs/box_xstudyarea_huezone.png)
###### Figure 17: Box Plots of Errors by Geographic Zone and Year
![alt text](../validation/aggregate_results/figs/box_x_zone_hue_yr.png)

The relationship between topography and error is analyzed by
extracting values from a variety of DEM derivative rasters and comparing them to colocated error values. There are two sets of DEM derivatives: hillshade rasters and surface roughness rasters. Hillshade rasters illuminated from four different azimuths (45, 135, 225, and 315 degrees) have intensity values ranging from 0 (no illumination and black) to 255 (full illumination and white). The surface roughness rasters are slope (degrees), the terrain prominence index (TPI), the terrain ruggedness index (TRI), and roughness. Both sets of rasters are computed by GDAL commands (see Appendix 5: DEM Derivatives). Scatterplots compare error values with hillshade and surface roughness values for each study area (Figure 18).

###### Figure 18: Topographic Error Analysis

![alt text](../validation/aggregate_results/figs/CLPX_hillshade_error_analysis.png)
![alt text](../validation/aggregate_results/figs/CLPX_roughness_error_analysis.png)
![alt text](../validation/aggregate_results/figs/Happy_Valley_hillshade_error_analysis.png)
![alt text](../validation/aggregate_results/figs/Happy_Valley_roughness_error_analysis.png)

### 4.3 Validation Discussion

<p>
The overall errors are quite similar across each year and study area and the MagnaProbe snow depth measurements and the airborne snow depth retreivals have very similar distributions. The snow depth dDEM is negatively shifted with respect to the corresponding MangaProbe distribution in the violin plots (Figure 12, Table 1). The same plot indicates there is interannual variation in these distributions, but this variation is likely a function of changing MagnaProbe survey strategies and locations. The annual magnitude of the snow depth dDEM mean error ranges from 0.11 m to 0.43 m, but error variance is well constrained (annual standard deviation values range between 0.11 and 0.19 m, with 2018 Happy Valley being the outlier, Table 1). This consistent amount of variance across years and study areas explains why the error distributions look so similar for each year and study area (Figure 13).
</p>

<p>
While the errors are generally consistent over time and between the two study areas, we should also know whether or not the errors are consistent within each year and study area. Do the snow depth dDEMs perform better or worse with respect to the MagnaProbe snow depth measurements in certain locations or types of terrain? Or are the errors stationary across the entire domain for a single year? The spatial dependence of the errors, if any, will inform how to use the error analysis to correct the snow depth dDEMs. At Happy Valley, three regions have very similar error distributions: Happy Valley South, Happy Valley North, and Happy Valley Stream (Figure 15). The consistency of these errors may be driven by similar, linear sampling regimes with high N values that parallel the North-South orientation of the swath. The Crescent Lake and Watertracks zones have lower median errors (Figure 16), but have far smaller N values and surveys were intentionally aligned with the prevailing winter wind direction (West to East) to capture snowdrifts. The area of the latter two zones is much smaller as well (Crescent Lake is a single snowdrift overlaying the bank of a small tundra lake.)
</p>

<p>
At CLPX the error distributions for every geographic zone are tightly clustered (Figure 15), although the CLPX West zone has the greatest median error (Figure 16), perhaps due to a relatively low N value. The boxplots for the CLPX East and Imnavait zones are nearly identical (Figure 16) despite their disparate wind regimes and snowpacks. The low variance of the Imnavait North zone errors can probably be explained by sparse MagnaProbe coverage: these are the few points that lie North of the 1 by 1 km grids but have similar eastings to Imnavait proper. There is no signigicant variance in error across geographic zones when results from all years are considered together. Splitting the results by geographic zone and by year (Figure 17) shows some interannual variation within individual zones (e.g. Imnavait) but strong intra-annual consistency across zones. The relative position on the y-axis of the annual boxplots is consistent for many of the individual zones (Figure 17). The results here do not indicate strong spatial biases in the errors. There is variability, but this variability may be expected because of the variable sampling schemes employed at each year and zone. The topographic error analysis yields similar results: hillshade and surface roughness measures do not have signficant relationships with the error for either study area (Figure 18).
</p>

### 4.4 Correcting the Snow Depth Rasters Using the Error Analysis

<p>
Given that there is no obvious geographic or topographic influence on the errors, we apply a global correction to each snow depth dDEM that is equal to the mean error for that study area and year (Table 1). Essentially we add a constant value to each pixel in the snow depth dDEM (e.g. the entire 2012 Happy Valley snow depth dDEM is 0.12 m deeper after the correction is applied). The 'corrected' snow depth dDEMS are then the basis for all further analyses. The arithmetic global adjustments of the data seem favorable at this time because they are simple and easily explained, and based on thousands of ground truth measurements. We can remain open to other adjustment schemes, but currently there is no clear justification for a more specific or complex method based on geographic or topographic parameters.
</p>

<p>
One gap in the error analysis is the nonexistent 2016 validation points for Happy Valley. One option is to use the mean of all Happy Valley annual mean errors (0.17 m) to correct the snow depth dDEM. Another option is to use the mean error from the same year, but from the other study area (CLPX 2016; 0.40 m). An arguement for using 0.17 m is that in every year the median error for CLPX is greater than the median error at Happy Valley (Figure 14). However, as discussed earlier, the errors are consistent through time across different geographic zones. For example, for every geographic zone the 2016 median error is greater than the 2012 and 2013 median errors (Figure 17). With this behavior in mind we can weight the 2016 CLPX median error by the tendency of the Happy Valley errors to be less than the CLPX errors. The Happy Valley mean error (all years) accounts for 59% of the CLPX mean error (all years exlcuding 2016). We adjust the CLPX 2016 mean error of 0.40 m by 59% to 0.24 m and use this value to correct the 2016 Happy Valley snow depth dDEM.
</p>


## Conclusion and Moving Forward
<p>
- We have adjusted every raster by some amount.
- Errors are attributable.
- Ground truth (BIG N) makes us confident to move forward.
</p>
